<!doctype html><html lang=zh-CN><head><title>事务 // 笔记网站</title>
<link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.121.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="borong.cheng"><meta name=description content><link rel=stylesheet href=/static/css/main.min.5b1fcc8902588589c4767187402a3c29f8b8d7a6fdef6d9f8f77045bb0d14fee.css><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://borongcheng.github.io/static/%E9%A6%96%E9%A1%B5%E4%B8%AD%E9%97%B4%E7%9A%84%E5%9B%BE%E7%89%87"><meta name=twitter:title content="事务"><meta name=twitter:description content="一、定义 1、什么是事务 事务就是一个并发控制单元，要求一次操作序列，要么全部成功要么全部失败。 这些操作要么全部成功，对数据造成影响，要么全部失"><meta property="og:title" content="事务"><meta property="og:description" content="一、定义 1、什么是事务 事务就是一个并发控制单元，要求一次操作序列，要么全部成功要么全部失败。 这些操作要么全部成功，对数据造成影响，要么全部失"><meta property="og:type" content="article"><meta property="og:url" content="https://borongcheng.github.io/static/specialized/java/base/spring/transaction/"><meta property="og:image" content="https://borongcheng.github.io/static/%E9%A6%96%E9%A1%B5%E4%B8%AD%E9%97%B4%E7%9A%84%E5%9B%BE%E7%89%87"><meta property="article:section" content="specialized"><meta property="article:published_time" content="2024-08-28T11:52:54+00:00"><meta property="article:modified_time" content="2025-09-17T18:10:49+08:00"><meta property="og:site_name" content="柏荣的博客"></head><body><header class=app-header><a href=https://borongcheng.github.io/static/><img class=app-header-avatar src=/static/avatar.jpg alt=borong.cheng></a>
<span class=app-header-title>笔记网站</span><nav class=app-header-menu><a class=app-header-menu-item href=/static/>Home</a>
-
<a class=app-header-menu-item href=/static/categories/>类别</a>
-
<a class=app-header-menu-item href=/static/tags/>Tags</a></nav><p>柏荣的博客</p></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>事务</h1><div class=post-meta><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Aug 28, 2024</div><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>37 min read</div><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://borongcheng.github.io/static/tags/java/>JAVA</a>
<a class=tag href=https://borongcheng.github.io/static/tags/spring/>Spring</a></div></div></header><div class=post-content><h1 id=一定义>一、定义</h1><p>1、什么是事务
事务就是一个并发控制单元，要求一次操作序列，要么全部成功要么全部失败。
这些操作要么全部成功，对数据造成影响，要么全部失败对事务不造成影响。在数据库和信息系统中事务一般用于确保数据的一致性。
2、事务的四大特性</p><ul><li>原子性<ul><li>事务是一个不可分割的单元，要么全部执行成功，要么全部执行失败，操作序列里面有一个执行失败，那么它之前的执行都需要回滚。</li></ul></li><li>一致性<ul><li>事务的执行结果必须使数据库从一个一致状态转变成另一个一致状态，这意味着事务中的操作或更改必须遵循所有定义好的规则和约束，以确保数据的完整性。</li></ul></li><li>隔离性<ul><li>多个事务同时执行，需要确保各个事务之间被隔离开来，互相之间不受影响。</li><li>事务隔离可以防止一些问题，例如：脏读，幻读，不可重复读。</li></ul></li><li>持久性<ul><li>一旦事务提交之后，其对数据库的修改是持久的，就算数据库宕机也能从文件中恢复数据。</li></ul></li></ul><p>3、spring中事务的传播类型
针对事务的传播类型，主要作用就是区分子事务和父事务之间的关系。</p><ul><li>请求从父事务传播到子事务时，是否共用同一个事务</li><li>子事务异常时，父事务是否会回滚</li><li>父事务异常时，子事务是否会回滚</li><li>父事务捕获了异常之后，父事务是否还会回滚</li></ul><p><strong>常用的三个事务</strong></p><ul><li>Required<ul><li>spring的默认事务传播类型，子事务加入父事务，共用一个事务。</li><li>发生异常，不管是哪个事务中都会回滚，即使子事务抛出异常被父事务捕获也会回滚</li></ul></li><li>Required_new<ul><li>子事务不关注父事务，单独创建新事务，两者事务独立，互不干扰。</li><li>但是父事务需要注意在调用子方法的时候抛出的异常，会造成父事务回滚，需要捕获。</li></ul></li><li>Nested<ul><li>嵌套事务，子事务嵌套父事务使用，子事务不独立依托父事务存在，子事务回滚，父事务在捕获子方法异常的情况下不会回滚。</li></ul></li></ul><p><strong>不常用的四个事务</strong></p><ul><li>Supports<ul><li>支持事务，如果父事务存在则加入父事务，如果父事务不存在则以无事务方式运行</li></ul></li><li>Not_Supported<ul><li>不支持事务，如果存在父事务，则将父事务挂起</li></ul></li><li>Never<ul><li>要求当前无事务，存在事务则抛出异常</li></ul></li><li>Mandatory<ul><li>要求存在事务，不存在则抛出异常</li></ul></li></ul><p>4、spring中事务什么时候会失效
spring事务是通过AOP实现的，事务失效即AOP失效的一些情况。</p><ul><li>@Transactional注解描述的非public方法</li><li>自调用<ul><li>类自身调用事务方法，只有通过代理对象调用才会触发事务管理。</li></ul></li><li>代理模式限制<ul><li>如果是jdk动态代理，需要目标对象实现接口。</li></ul></li><li>多线程问题<ul><li>spring的事务管理是于线程绑定，如果存在线程上下文切换，事务不会自动传播到新线程中，事务将会失效。</li><li>需要通过传递TransactionSynchronizationManager相关的事务信息来确保事务在多线程环境中的正确传播。</li></ul></li></ul><h1 id=二解读>二、解读</h1><h3 id=1启用方式>1、启用方式</h3><blockquote><p>spring中通常有两种启用事务的方式：XML文件配置、注解配置以及声明式配置</p></blockquote><p><strong>XML文件配置</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;beans&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!-- 定义一个数据源 --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;bean</span> <span class=na>id=</span><span class=s>&#34;dataSource&#34;</span> <span class=na>class=</span><span class=s>&#34;com.alibaba.druid.pool.DruidDataSource&#34;</span><span class=nt>&gt;</span>...<span class=nt>&lt;/bean&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!-- 事务管理器 --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;bean</span> <span class=na>id=</span><span class=s>&#34;txManager&#34;</span> <span class=na>class=</span><span class=s>&#34;org.springframework.jdbc.datasource.DataSourceTransactionManager&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=c>&lt;!-- 指定数据源 --&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;property</span> <span class=na>name=</span><span class=s>&#34;dataSource&#34;</span> <span class=na>ref=</span><span class=s>&#34;dataSource&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/bean&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!-- 事务模块驱动，指定使用上面定义事务管理器，默认值为 transactionManager --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;tx:annotation-driven</span> <span class=na>transaction-manager=</span><span class=s>&#34;txManager&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/beans&gt;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>1、设置数据源
2、设置事务管理器
3、根据事务管理器指定数据源
4、启用注解驱动的事务管理器</p></blockquote><p><strong>注解配置</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableTransactionManagement</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AppConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>dataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 配置数据源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>PlatformTransactionManager</span><span class=w> </span><span class=nf>transactionManager</span><span class=p>(</span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceTransactionManager</span><span class=p>(</span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>1、使用@EnableTransactionManagement注解开启事务支持
2、配置DataSource数据源
3、配置事务管理器类DataSourceTransaction,注入数据源datasource</p></blockquote><p><strong>声明式配置</strong></p><h3 id=2源码解析>2、源码解析</h3><h4 id=enabletransactionmanagement>EnableTransactionManagement</h4><blockquote><p>spring中的一个注解，用于启用注解驱动的事务管理功能。主要作用是通过AOP在Spring应用中自动配置事务管理。
<strong>主要功能</strong></p><ul><li>导入事务管理配置<ul><li>当你在配置类上使用了@EnableTransactionManagement注解时，Spring会自动导入相关的配置类，这些配置类负责设置事务管理器、代理和其他必要的基础设施。</li></ul></li><li>创建事务代理<ul><li>该注解会自动为标记了事务注解（@Transactional）的方法创建代理对象。通过这些代理对象，Spring可以在方法调用前后进行事务管理操作，例如开启事务、提交事务或回滚事务。</li></ul></li><li>配置事务管理器<ul><li>Spring需要一个PlatformTransactionManager。来实际管理事务。@EnableTransactionManager会自动查找并配置一个合适的事务管理器；如果存在多个事务管理器，可以在@Transactional注解中指定TransactionMananger属性使用哪个事务管理器。</li></ul></li></ul></blockquote><p><strong>工作原理</strong></p><blockquote><ul><li>引入配置类<ul><li>该注解会引入ProxyTransactionManagementConfiguration或AspectJTransactionManagementConfiguration配置类，没有指定mode时，默认使用ProxyTransactionManagementConfiguration。</li><li>ProxyTransactionManagementConfiguration:<ul><li>默认使用的配置类，基于代理实现事务管理，通过代理对象和拦截器，实现了在方法调用前后启动、提交、回滚事务的功能。</li></ul></li><li>AspectJTransactionManagementConfiguration<ul><li>可选配置类，使用AspectJ语法实现事务管理，在编译或者运行期织入切面逻辑。</li></ul></li></ul></li></ul></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Target</span><span class=p>({</span><span class=n>ElementType</span><span class=p>.</span><span class=na>TYPE</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Documented</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Import</span><span class=p>({</span><span class=n>TransactionManagementConfigurationSelector</span><span class=p>.</span><span class=na>class</span><span class=p>})</span><span class=err>。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>EnableTransactionManagement</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 表示是否创建基于子类的（CGLIB）代理，而不是标准的基于 Java 接口的代理。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>proxyTargetClass</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 指示事务通知应该如何应用。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AdviceMode</span><span class=w> </span><span class=nf>mode</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>AdviceMode</span><span class=p>.</span><span class=na>PROXY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 该注解在相对于其他注解的处理顺序。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>order</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>2147483647</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>protected</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=nf>selectImports</span><span class=p>(</span><span class=n>AdviceMode</span><span class=w> </span><span class=n>adviceMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//根据注解的mode属性来选择使用那个配置类，默认使用ProxyTransactionManagementConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>adviceMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>case</span><span class=w> </span><span class=n>PROXY</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>AutoProxyRegistrar</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>(),</span><span class=w> </span><span class=n>ProxyTransactionManagementConfiguration</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>()};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>case</span><span class=w> </span><span class=n>ASPECTJ</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>TransactionManagementConfigUtils</span><span class=p>.</span><span class=na>TRANSACTION_ASPECT_CONFIGURATION_CLASS_NAME</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>按默认配置，这里往Spring容器里面注入了两个配置类，分别是AutoProxyRegistrar、ProxyTransactionManagementConfiguration</p></blockquote><p><strong>AutoProxyRegistrar</strong></p><blockquote><p>找到enableTransactionManagement注解，获取属性参数，注册自动代理器，设置代理方式。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>registerBeanDefinitions</span><span class=p>(</span><span class=n>AnnotationMetadata</span><span class=w> </span><span class=n>importingClassMetadata</span><span class=p>,</span><span class=w> </span><span class=n>BeanDefinitionRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>candidateFound</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=c1>// 标记是否找到合适的候选配置注解</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>annoTypes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>importingClassMetadata</span><span class=p>.</span><span class=na>getAnnotationTypes</span><span class=p>();</span><span class=w> </span><span class=c1>// 获取导入类的所有注解类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>annoType</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>annoTypes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AnnotationAttributes</span><span class=w> </span><span class=n>candidate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AnnotationConfigUtils</span><span class=p>.</span><span class=na>attributesFor</span><span class=p>(</span><span class=n>importingClassMetadata</span><span class=p>,</span><span class=w> </span><span class=n>annoType</span><span class=p>);</span><span class=w> </span><span class=c1>// 获取注解的属性值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>candidate</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>continue</span><span class=p>;</span><span class=w> </span><span class=c1>// 如果属性值为空，跳过当前注解</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>candidate</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;mode&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 获取属性值中的 &#39;mode&#39; 属性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>proxyTargetClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>candidate</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;proxyTargetClass&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 获取属性值中的 &#39;proxyTargetClass&#39; 属性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>proxyTargetClass</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>AdviceMode</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>mode</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Boolean</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>proxyTargetClass</span><span class=p>.</span><span class=na>getClass</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>candidateFound</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=c1>// 找到合适的候选配置注解</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>AdviceMode</span><span class=p>.</span><span class=na>PROXY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 如果 &#39;mode&#39; 属性为 AdviceMode.PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>AopConfigUtils</span><span class=p>.</span><span class=na>registerAutoProxyCreatorIfNecessary</span><span class=p>(</span><span class=n>registry</span><span class=p>);</span><span class=w> </span><span class=c1>// 注册自动代理创建器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>Boolean</span><span class=p>)</span><span class=w> </span><span class=n>proxyTargetClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 如果 &#39;proxyTargetClass&#39; 属性为 true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>AopConfigUtils</span><span class=p>.</span><span class=na>forceAutoProxyCreatorToUseClassProxying</span><span class=p>(</span><span class=n>registry</span><span class=p>);</span><span class=w> </span><span class=c1>// 强制使用基于类的代理即CGLIB代理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w> </span><span class=c1>// 方法结束</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>candidateFound</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getClass</span><span class=p>().</span><span class=na>getSimpleName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>logger</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;%s was imported but no annotations were found &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;having both &#39;mode&#39; and &#39;proxyTargetClass&#39; attributes of type &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;AdviceMode and boolean respectively. This means that auto proxy &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;creator registration and configuration may not have occurred as &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;intended, and components may not be proxied as expected. Check to &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;ensure that %s has been @Import&#39;ed on the same class where these &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;annotations are declared; otherwise remove the import of %s &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;altogether.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>));</span><span class=w> </span><span class=c1>// 输出警告日志，表示未找到合适的配置注解</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>registerAutoProxyCreatorIfNecessary</strong></p><blockquote><p>注册自动代理器：
自动代理器的作用是在Spring中为符合条件的bean创建代理对象。
1、检查是否存在自动代理器，存在则比较两者优先级，如果优先级低会升级到更高优先级。
2、不存在则直接创建一个新的。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>BeanDefinition</span><span class=w> </span><span class=nf>registerAutoProxyCreatorIfNecessary</span><span class=p>(</span><span class=n>BeanDefinitionRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>return</span><span class=w> </span><span class=n>registerAutoProxyCreatorIfNecessary</span><span class=p>(</span><span class=n>registry</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>Object</span><span class=p>)</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>BeanDefinition</span><span class=w> </span><span class=nf>registerAutoProxyCreatorIfNecessary</span><span class=p>(</span><span class=n>BeanDefinitionRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>source</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>return</span><span class=w> </span><span class=n>registerOrEscalateApcAsRequired</span><span class=p>(</span><span class=n>InfrastructureAdvisorAutoProxyCreator</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>registry</span><span class=p>,</span><span class=w> </span><span class=n>source</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// @Nullable 注解表示参数可以为 null。方法的目的是确保在 BeanDefinitionRegistry 中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 注册一个合适的 Auto Proxy Creator (APC)，如果需要的话。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Nullable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>BeanDefinition</span><span class=w> </span><span class=nf>registerOrEscalateApcAsRequired</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>cls</span><span class=p>,</span><span class=w> </span><span class=n>BeanDefinitionRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>source</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 检查 registry 参数是否为 null，如果为 null 则抛出异常。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Assert</span><span class=p>.</span><span class=na>notNull</span><span class=p>(</span><span class=n>registry</span><span class=p>,</span><span class=w> </span><span class=s>&#34;BeanDefinitionRegistry must not be null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 检查注册表中是否已经存在名为 AUTO_PROXY_CREATOR_BEAN_NAME 的 Bean 定义。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>registry</span><span class=p>.</span><span class=na>containsBeanDefinition</span><span class=p>(</span><span class=n>AUTO_PROXY_CREATOR_BEAN_NAME</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取当前注册的 APC 的 Bean 定义。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanDefinition</span><span class=w> </span><span class=n>apcDefinition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>registry</span><span class=p>.</span><span class=na>getBeanDefinition</span><span class=p>(</span><span class=n>AUTO_PROXY_CREATOR_BEAN_NAME</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 检查当前注册的 APC 类名是否与传入的 cls 不同。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cls</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>apcDefinition</span><span class=p>.</span><span class=na>getBeanClassName</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 获取当前 APC 类的优先级。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>currentPriority</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findPriorityForClass</span><span class=p>(</span><span class=n>apcDefinition</span><span class=p>.</span><span class=na>getBeanClassName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 获取传入的 cls 类的优先级。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>requiredPriority</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findPriorityForClass</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果当前 APC 的优先级低于传入的 cls 类的优先级，则升级 APC。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>currentPriority</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>requiredPriority</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 将当前 APC 的类名设置为 cls 类的类名。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>apcDefinition</span><span class=p>.</span><span class=na>setBeanClassName</span><span class=p>(</span><span class=n>cls</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 返回 null 表示没有创建新的 APC，而是可能升级了现有的 APC。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果没有现有的 APC，则创建一个新的 RootBeanDefinition 实例。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RootBeanDefinition</span><span class=w> </span><span class=n>beanDefinition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RootBeanDefinition</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 设置 Bean 的源信息，用于跟踪配置来源，可以为 null。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>beanDefinition</span><span class=p>.</span><span class=na>setSource</span><span class=p>(</span><span class=n>source</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 设置 APC 的顺序属性为最高优先级。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>beanDefinition</span><span class=p>.</span><span class=na>getPropertyValues</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;order&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Ordered</span><span class=p>.</span><span class=na>HIGHEST_PRECEDENCE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 设置 Bean 的角色为基础设施角色。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>beanDefinition</span><span class=p>.</span><span class=na>setRole</span><span class=p>(</span><span class=n>BeanDefinition</span><span class=p>.</span><span class=na>ROLE_INFRASTRUCTURE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 将新的 APC 注册到 Bean 定义注册表中。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registry</span><span class=p>.</span><span class=na>registerBeanDefinition</span><span class=p>(</span><span class=n>AUTO_PROXY_CREATOR_BEAN_NAME</span><span class=p>,</span><span class=w> </span><span class=n>beanDefinition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 返回新的 APC 的 Bean 定义。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>beanDefinition</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>ProxyTransactionMannageConfiguration</strong></p><blockquote><p>是spring框架中配置代理事务管理的类之一，它的作用主要用于Spring应用程序中启用基于代理的事务管理。
主要作用包括：</p><ul><li>启用代理事务管理<ul><li>通过@Configuration注解标记自己是个配置类，通常与@EnableAspectJAutoProxy注解一起使用，用于启用基于代理的AOP功能，包括事务注解。</li></ul></li><li>配置事务管理器<ul><li>包含对事务管理器的配置，例如定义数据源、事务传播行为、事务超时等。</li></ul></li><li>生成代理对象<ul><li>在启用基于代理的AOP功能后，Spring框架会根据配置生成代理对象，用来包裹需要进行事务管理的目标对象，从而实现事务管理的功能。</li></ul></li></ul></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 代理事务管理配置类，用于配置代理事务管理相关的组件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ProxyTransactionManagementConfiguration</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractTransactionManagementConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 定义名为TRANSACTION_ADVISOR_BEAN_NAME的Bean，类型为BeanFactoryTransactionAttributeSourceAdvisor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TransactionManagementConfigUtils</span><span class=p>.</span><span class=na>TRANSACTION_ADVISOR_BEAN_NAME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Role</span><span class=p>(</span><span class=n>BeanDefinition</span><span class=p>.</span><span class=na>ROLE_INFRASTRUCTURE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>BeanFactoryTransactionAttributeSourceAdvisor</span><span class=w> </span><span class=nf>transactionAdvisor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 创建BeanFactoryTransactionAttributeSourceAdvisor实例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanFactoryTransactionAttributeSourceAdvisor</span><span class=w> </span><span class=n>advisor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BeanFactoryTransactionAttributeSourceAdvisor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置事务属性源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>advisor</span><span class=p>.</span><span class=na>setTransactionAttributeSource</span><span class=p>(</span><span class=n>transactionAttributeSource</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置事务拦截器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>advisor</span><span class=p>.</span><span class=na>setAdvice</span><span class=p>(</span><span class=n>transactionInterceptor</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>enableTx</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果enableTx不为空，设置排序顺序</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>advisor</span><span class=p>.</span><span class=na>setOrder</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>enableTx</span><span class=p>.</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=n>getNumber</span><span class=p>(</span><span class=s>&#34;order&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>advisor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 定义事务属性源的Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Role</span><span class=p>(</span><span class=n>BeanDefinition</span><span class=p>.</span><span class=na>ROLE_INFRASTRUCTURE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>TransactionAttributeSource</span><span class=w> </span><span class=nf>transactionAttributeSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 返回AnnotationTransactionAttributeSource实例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AnnotationTransactionAttributeSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 定义事务拦截器的Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Role</span><span class=p>(</span><span class=n>BeanDefinition</span><span class=p>.</span><span class=na>ROLE_INFRASTRUCTURE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>TransactionInterceptor</span><span class=w> </span><span class=nf>transactionInterceptor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 创建TransactionInterceptor实例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TransactionInterceptor</span><span class=w> </span><span class=n>interceptor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransactionInterceptor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置事务属性源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>interceptor</span><span class=p>.</span><span class=na>setTransactionAttributeSource</span><span class=p>(</span><span class=n>transactionAttributeSource</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>txManager</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果txManager不为空，设置事务管理器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>interceptor</span><span class=p>.</span><span class=na>setTransactionManager</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>txManager</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>interceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>通过以上代码可以看出来ProxyTransactionManageConfiguration配置类的主要作用是注册3个bean：</p><ul><li>TransactionAttributeSource<ul><li>定义事件属性源，被Pointcut和Advice关联；主要负责提供事务属性，如传播行为，隔离级别等；</li><li>通过getTransactionAttribute方法去获取特定方法的属性，通过这个方法Spring可以确定在调用某个方法时，应该用什么事务规则。</li></ul></li><li>TransactionInterceptor<ul><li>事务拦截器，关联着一个TransactionAttributeSource对象。</li><li>它通过拦截方法调用并在方法执行前后应用事务管理逻辑，确保方法在事务边界内执行。</li><li>根据TransactionAttributeSource获取到事务属性，根据这些事务属性正确设置事务上下文和行为。</li></ul></li><li>BeanFactoryTransactionAttributeSourceAdvisor<ul><li>它集成了AOP和事务管理，确保方法在调用中自动应用事务逻辑。</li></ul></li></ul></blockquote><p><strong>CanApply</strong></p><blockquote><p>spring是通过代理的形式去进行事务管理，事务代码逻辑的开始入口就在代理那块，跟踪代码调用流程：</p><ul><li>&mldr;&mldr;</li><li>initializeBean:初始化bean之后</li><li>beanPostProcessor：调用bean注册的beanPostProcessor</li><li>wrapIfNecessary：bean实例化之后检查是否需要代理或者包装</li><li>findAdvisorsThatCanApply：获取和这个类匹配的加强（及切面）</li><li>canApply：代理处理事务的入口<ul><li>作用是确定是否可以将给定的切面应用到目标类或者方法上。</li></ul></li><li>&mldr;..</li></ul></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>canApply</span><span class=p>(</span><span class=n>Advisor</span><span class=w> </span><span class=n>advisor</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>targetClass</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasIntroductions</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果advisor是引介增强类，则直接返回其类过滤器是否匹配目标类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>advisor</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>IntroductionAdvisor</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>IntroductionAdvisor</span><span class=p>)</span><span class=w> </span><span class=n>advisor</span><span class=p>).</span><span class=na>getClassFilter</span><span class=p>().</span><span class=na>matches</span><span class=p>(</span><span class=n>targetClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果是切点增强类，则进入进一步处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>advisor</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>PointcutAdvisor</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PointcutAdvisor</span><span class=w> </span><span class=n>pca</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>PointcutAdvisor</span><span class=p>)</span><span class=w> </span><span class=n>advisor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>canApply</span><span class=p>(</span><span class=n>pca</span><span class=p>.</span><span class=na>getPointcut</span><span class=p>(),</span><span class=w> </span><span class=n>targetClass</span><span class=p>,</span><span class=w> </span><span class=n>hasIntroductions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 对于其他类型的增强，默认返回true，即适用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>canApply</span><span class=p>(</span><span class=n>Pointcut</span><span class=w> </span><span class=n>pc</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>targetClass</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasIntroductions</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 检查切点不为空</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Assert</span><span class=p>.</span><span class=na>notNull</span><span class=p>(</span><span class=n>pc</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Pointcut must not be null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果切点的类过滤器不匹配目标类，则直接返回false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>pc</span><span class=p>.</span><span class=na>getClassFilter</span><span class=p>().</span><span class=na>matches</span><span class=p>(</span><span class=n>targetClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MethodMatcher</span><span class=w> </span><span class=n>methodMatcher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pc</span><span class=p>.</span><span class=na>getMethodMatcher</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果方法匹配器是TRUE，表示所有方法都匹配，直接返回true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>methodMatcher</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MethodMatcher</span><span class=p>.</span><span class=na>TRUE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>IntroductionAwareMethodMatcher</span><span class=w> </span><span class=n>introductionAwareMethodMatcher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果方法匹配器是IntroductionAwareMethodMatcher的实例，则进行类型转换</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>methodMatcher</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>IntroductionAwareMethodMatcher</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>introductionAwareMethodMatcher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>IntroductionAwareMethodMatcher</span><span class=p>)</span><span class=w> </span><span class=n>methodMatcher</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取目标类及其所有接口的集合</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>classes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedHashSet</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>ClassUtils</span><span class=p>.</span><span class=na>getAllInterfacesForClassAsSet</span><span class=p>(</span><span class=n>targetClass</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>classes</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>targetClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>clazz</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>classes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取当前类的所有声明的方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Method</span><span class=o>[]</span><span class=w> </span><span class=n>methods</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ReflectionUtils</span><span class=p>.</span><span class=na>getAllDeclaredMethods</span><span class=p>(</span><span class=n>clazz</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>methods</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 检查方法匹配器是否匹配当前方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>introductionAwareMethodMatcher</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=n>introductionAwareMethodMatcher</span><span class=p>.</span><span class=na>matches</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>targetClass</span><span class=p>,</span><span class=w> </span><span class=n>hasIntroductions</span><span class=p>))</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//进入方法，选择TransactionAttributeSourcePointcut实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>methodMatcher</span><span class=p>.</span><span class=na>matches</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>targetClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果没有找到匹配的方法，则返回false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>进一步检查切点是否作用与目标类上，主要通过classFilter()类过滤器和methodMatcher方法匹配器判断。</p><ul><li>classFilter<ul><li>用于检查某个类是否符合切点。</li></ul></li><li>methodMatcher<ul><li>用于检查类的某个方法是否符合切点</li></ul></li></ul></blockquote><p><strong>TransactionAttributeSourcePointcut</strong></p><blockquote><p>spring框架中的一个特殊的切点类，用于确定哪些方法应该用事务增强（例如，事务管理），主要用来识别带有特定事务属性的方法。
TransactionAttributeSourcePointcut结合TransactionAttributeSource来决定哪些方法需要事务管理。这些方法通常会通过事务注解@Transactional或者XML去显式的指定其事务属性。
TransactionAttributeSourcePointcut作用如下：
1、匹配方法：检查目标类的方法是否具有事务属性
2、集成事务管理器：如果一个方法具有事务属性，那spring AOP会拦截该方法的调用，并在调用前后应用相应的事务处理。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>matches</span><span class=p>(</span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>targetClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果目标类不为空并且目标类是TransactionalProxy的子类或实现类，返回false。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 这意味着如果目标类本身已经是一个事务代理对象，则不需要再进行事务增强。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>targetClass</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>TransactionalProxy</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>targetClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取事务属性源（TransactionAttributeSource）。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 这是用于获取方法上的事务属性的组件。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TransactionAttributeSource</span><span class=w> </span><span class=n>tas</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getTransactionAttributeSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果事务属性源为null，或者通过事务属性源获取到的方法事务属性不为null，则认为该方法匹配。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 即，如果tas为null，表示没有特定的事务属性源，所有方法默认匹配；</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果tas.getTransactionAttribute(method, targetClass)返回非null，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 表示该方法有特定的事务属性，也认为该方法匹配。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>tas</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>tas</span><span class=p>.</span><span class=na>getTransactionAttribute</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>targetClass</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>1、排除TransactionProxy或其子类，该类已被事务代理，不需要再次应用事务增强
2、获取事务属性，如果没有配置事务源或者通过事务源返回了事务属性则匹配成功。</p></blockquote><p><strong>getTransactionAttribute</strong></p><blockquote><p>获取传入方法的事务属性；
1、过滤object方法
2、获取缓存值返回
3、不存在缓存值，计算属性，将属性缓存并返回。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Nullable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>TransactionAttribute</span><span class=w> </span><span class=nf>getTransactionAttribute</span><span class=p>(</span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>targetClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果该方法是Object类中声明的方法，则返回null，表示没有事务属性。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getDeclaringClass</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 首先检查是否有缓存值。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>cacheKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getCacheKey</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>targetClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>cached</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>attributeCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cached</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 缓存值可能是表示没有事务属性的规范值，或者是实际的事务属性。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cached</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NULL_TRANSACTION_ATTRIBUTE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// 返回null表示没有事务属性。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>TransactionAttribute</span><span class=p>)</span><span class=w> </span><span class=n>cached</span><span class=p>;</span><span class=w> </span><span class=c1>// 返回缓存的事务属性。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 需要计算事务属性。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TransactionAttribute</span><span class=w> </span><span class=n>txAttr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>computeTransactionAttribute</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>targetClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 将计算得到的事务属性放入缓存。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txAttr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=c1>// 如果当前方法上没有事务属性，则缓存一个表示空事务属性的对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>attributeCache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span><span class=w> </span><span class=n>NULL_TRANSACTION_ATTRIBUTE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>methodIdentification</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClassUtils</span><span class=p>.</span><span class=na>getQualifiedMethodName</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>targetClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txAttr</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>DefaultTransactionAttribute</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 如果生成的事务属性是DefaultTransactionAttribute类型的，则将方法签名设置到其descriptor属性中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>((</span><span class=n>DefaultTransactionAttribute</span><span class=p>)</span><span class=w> </span><span class=n>txAttr</span><span class=p>).</span><span class=na>setDescriptor</span><span class=p>(</span><span class=n>methodIdentification</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=p>.</span><span class=na>isDebugEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Adding transactional method &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>methodIdentification</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; with attribute: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>txAttr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>attributeCache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span><span class=w> </span><span class=n>txAttr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>txAttr</span><span class=p>;</span><span class=w> </span><span class=c1>// 返回计算得到的事务属性。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>computeTransactionAttribute</strong></p><blockquote><p>该方法在获取事务属性过程中起着核心作用，它的主要功能是根据给定的方法和目标类，计算出该方法的事务属性。
方法一般作用和步骤：</p><ul><li>检查方法级别的注解<ul><li>首先检查方法本身是否存在注解，如@Transactional 注解</li><li>如果找到注解，解析该注解提取属性。</li></ul></li><li>检查类级别的注解<ul><li>如果方法上没找到注解，则检查声明此方法的类或接口上是否有事务性注解。</li><li>类注解可以为类中所有方法提供默认事务属性。</li></ul></li><li>继承与几口处理<ul><li>处理方法重载、继承和实现的情况</li><li>确保父类或者实现接口上的事务注解能够正确的应用与子类或者实现类的方法。</li></ul></li><li>默认值的应用<ul><li>如果没找到显式的事务注解，可能会应用一些默认的事务属性。</li></ul></li><li>返回事务属性<ul><li>根据上述检查和解析结果，构建并返回一个TransactionAttribute对象，描述该方法的事务行为。</li><li>如果没找到则返回null</li></ul></li></ul></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Nullable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=n>TransactionAttribute</span><span class=w> </span><span class=nf>computeTransactionAttribute</span><span class=p>(</span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>targetClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果仅允许公共方法并且该方法不是公共的，则返回 null。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>allowPublicMethodsOnly</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>Modifier</span><span class=p>.</span><span class=na>isPublic</span><span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getModifiers</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 忽略 CGLIB 动态代理的子类，获取实际的用户类。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果 targetClass 不为空，则获取用户类，否则 userClass 为 null。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>userClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>targetClass</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>ClassUtils</span><span class=p>.</span><span class=na>getUserClass</span><span class=p>(</span><span class=n>targetClass</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 方法可能在一个接口上定义，但我们需要从目标类中获取属性。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果 targetClass 为空，则方法保持不变。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Method</span><span class=w> </span><span class=n>specificMethod</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClassUtils</span><span class=p>.</span><span class=na>getMostSpecificMethod</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>userClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果我们处理的是带有泛型参数的方法，找到原始方法。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>specificMethod</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BridgeMethodResolver</span><span class=p>.</span><span class=na>findBridgedMethod</span><span class=p>(</span><span class=n>specificMethod</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 首先尝试从目标类中的特定方法上查找事务属性。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TransactionAttribute</span><span class=w> </span><span class=n>txAttr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findTransactionAttribute</span><span class=p>(</span><span class=n>specificMethod</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txAttr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>txAttr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 其次尝试从目标类自身查找事务属性。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>txAttr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findTransactionAttribute</span><span class=p>(</span><span class=n>specificMethod</span><span class=p>.</span><span class=na>getDeclaringClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txAttr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>ClassUtils</span><span class=p>.</span><span class=na>isUserLevelMethod</span><span class=p>(</span><span class=n>method</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>txAttr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果特定方法不是传入的方法，回退到检查原方法。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>specificMethod</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>method</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 尝试从原方法中查找事务属性。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>txAttr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findTransactionAttribute</span><span class=p>(</span><span class=n>method</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txAttr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>txAttr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 最后回退到检查原方法的声明类。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>txAttr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findTransactionAttribute</span><span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getDeclaringClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txAttr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>ClassUtils</span><span class=p>.</span><span class=na>isUserLevelMethod</span><span class=p>(</span><span class=n>method</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>txAttr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果没有找到任何事务属性，返回 null。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>findTransactionAttribute</strong></p><blockquote><p>根据给定方法，查找并返回方法上定义的事务属性。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=n>TransactionAttribute</span><span class=w> </span><span class=nf>findTransactionAttribute</span><span class=p>(</span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=n>determineTransactionAttribute</span><span class=p>(</span><span class=n>method</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>protected</span><span class=w> </span><span class=n>TransactionAttribute</span><span class=w> </span><span class=nf>determineTransactionAttribute</span><span class=p>(</span><span class=n>AnnotatedElement</span><span class=w> </span><span class=n>ae</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>TransactionAnnotationParser</span><span class=w> </span><span class=n>annotationParser</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>annotationParsers</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>TransactionAttribute</span><span class=w> </span><span class=n>attr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>annotationParser</span><span class=p>.</span><span class=na>parseTransactionAnnotation</span><span class=p>(</span><span class=n>ae</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>attr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=n>attr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=n>TransactionAttribute</span><span class=w> </span><span class=nf>parseTransactionAnnotation</span><span class=p>(</span><span class=n>AnnotatedElement</span><span class=w> </span><span class=n>ae</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>AnnotationAttributes</span><span class=w> </span><span class=n>attributes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AnnotatedElementUtils</span><span class=p>.</span><span class=na>findMergedAnnotationAttributes</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>ae</span><span class=p>,</span><span class=w> </span><span class=n>Transactional</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>attributes</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=n>parseTransactionAnnotation</span><span class=p>(</span><span class=n>attributes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>TransactionAttribute</span><span class=w> </span><span class=nf>parseTransactionAnnotation</span><span class=p>(</span><span class=n>AnnotatedElement</span><span class=w> </span><span class=n>ae</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 判断目标方法上是否存在@Transactional注解，如果不存在，则直接返回</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AnnotationAttributes</span><span class=w> </span><span class=n>attributes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AnnotatedElementUtils</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>findMergedAnnotationAttributes</span><span class=p>(</span><span class=n>ae</span><span class=p>,</span><span class=w> </span><span class=n>Transactional</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>attributes</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果目标方法上存在@Transactional注解，则获取注解值，并且封装为TransactionAttribute返回</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>parseTransactionAnnotation</span><span class=p>(</span><span class=n>attributes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=n>TransactionAttribute</span><span class=w> </span><span class=nf>parseTransactionAnnotation</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AnnotationAttributes</span><span class=w> </span><span class=n>attributes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RuleBasedTransactionAttribute</span><span class=w> </span><span class=n>rbta</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuleBasedTransactionAttribute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取注解上的propagation值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Propagation</span><span class=w> </span><span class=n>propagation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attributes</span><span class=p>.</span><span class=na>getEnum</span><span class=p>(</span><span class=s>&#34;propagation&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rbta</span><span class=p>.</span><span class=na>setPropagationBehavior</span><span class=p>(</span><span class=n>propagation</span><span class=p>.</span><span class=na>value</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取注解上的isolation属性值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Isolation</span><span class=w> </span><span class=n>isolation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attributes</span><span class=p>.</span><span class=na>getEnum</span><span class=p>(</span><span class=s>&#34;isolation&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rbta</span><span class=p>.</span><span class=na>setIsolationLevel</span><span class=p>(</span><span class=n>isolation</span><span class=p>.</span><span class=na>value</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取注解上的timeout属性值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rbta</span><span class=p>.</span><span class=na>setTimeout</span><span class=p>(</span><span class=n>attributes</span><span class=p>.</span><span class=na>getNumber</span><span class=p>(</span><span class=s>&#34;timeout&#34;</span><span class=p>).</span><span class=na>intValue</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取注解上的readOnly属性值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rbta</span><span class=p>.</span><span class=na>setReadOnly</span><span class=p>(</span><span class=n>attributes</span><span class=p>.</span><span class=na>getBoolean</span><span class=p>(</span><span class=s>&#34;readOnly&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取注解上的value属性值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rbta</span><span class=p>.</span><span class=na>setQualifier</span><span class=p>(</span><span class=n>attributes</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;value&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>RollbackRuleAttribute</span><span class=o>&gt;</span><span class=w> </span><span class=n>rollBackRules</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取注解上的rollbackFor属性列表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Class</span><span class=o>&lt;?&gt;[]</span><span class=w> </span><span class=n>rbf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attributes</span><span class=p>.</span><span class=na>getClassArray</span><span class=p>(</span><span class=s>&#34;rollbackFor&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>rbRule</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>rbf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RollbackRuleAttribute</span><span class=w> </span><span class=n>rule</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RollbackRuleAttribute</span><span class=p>(</span><span class=n>rbRule</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>rollBackRules</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>rule</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取注解上的rollbackForClassName属性列表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>rbfc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attributes</span><span class=p>.</span><span class=na>getStringArray</span><span class=p>(</span><span class=s>&#34;rollbackForClassName&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>rbRule</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>rbfc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RollbackRuleAttribute</span><span class=w> </span><span class=n>rule</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RollbackRuleAttribute</span><span class=p>(</span><span class=n>rbRule</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>rollBackRules</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>rule</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取注解上的noRollbackFor属性列表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Class</span><span class=o>&lt;?&gt;[]</span><span class=w> </span><span class=n>nrbf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attributes</span><span class=p>.</span><span class=na>getClassArray</span><span class=p>(</span><span class=s>&#34;noRollbackFor&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>rbRule</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>nrbf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>NoRollbackRuleAttribute</span><span class=w> </span><span class=n>rule</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NoRollbackRuleAttribute</span><span class=p>(</span><span class=n>rbRule</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>rollBackRules</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>rule</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取注解上的noRollbackForClassName属性列表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>nrbfc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attributes</span><span class=p>.</span><span class=na>getStringArray</span><span class=p>(</span><span class=s>&#34;noRollbackForClassName&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>rbRule</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>nrbfc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>NoRollbackRuleAttribute</span><span class=w> </span><span class=n>rule</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NoRollbackRuleAttribute</span><span class=p>(</span><span class=n>rbRule</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>rollBackRules</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>rule</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rbta</span><span class=p>.</span><span class=na>getRollbackRules</span><span class=p>().</span><span class=na>addAll</span><span class=p>(</span><span class=n>rollBackRules</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>rbta</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>invoke</strong></p><blockquote><p>&mldr;.
createTransactionIfNecessary：
prepareTransactionInfo：
completeTransactionAfterThrowing：
commitTransactionAfterReturing：</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>MethodInvocation</span><span class=w> </span><span class=n>invocation</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>targetClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>invocation</span><span class=p>.</span><span class=na>getThis</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>AopUtils</span><span class=p>.</span><span class=na>getTargetClass</span><span class=p>(</span><span class=n>invocation</span><span class=p>.</span><span class=na>getThis</span><span class=p>())</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// 往下看</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=n>invokeWithinTransaction</span><span class=p>(</span><span class=n>invocation</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(),</span><span class=w> </span><span class=n>targetClass</span><span class=p>,</span><span class=w> </span><span class=n>invocation</span><span class=p>::</span><span class=n>proceed</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 方法在事务内进行调用，可能会抛出 Throwable 异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>invokeWithinTransaction</span><span class=p>(</span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>targetClass</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>InvocationCallback</span><span class=w> </span><span class=n>invocation</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取事务属性源（TransactionAttributeSource）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TransactionAttributeSource</span><span class=w> </span><span class=n>tas</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getTransactionAttributeSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 根据方法和目标类获取事务属性，如果事务属性源为 null，则事务属性也为 null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>TransactionAttribute</span><span class=w> </span><span class=n>txAttr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>tas</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>tas</span><span class=p>.</span><span class=na>getTransactionAttribute</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>targetClass</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 确定使用哪个事务管理器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>PlatformTransactionManager</span><span class=w> </span><span class=n>tm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>determineTransactionManager</span><span class=p>(</span><span class=n>txAttr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取方法标识，用于日志等目的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>joinpointIdentification</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>methodIdentification</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>targetClass</span><span class=p>,</span><span class=w> </span><span class=n>txAttr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//声明式事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果没有事务属性或者事务管理器不是回调优先的事务管理器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txAttr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=n>tm</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>CallbackPreferringPlatformTransactionManager</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 使用标准的事务划分方式，通过 getTransaction 和 commit/rollback 进行处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TransactionInfo</span><span class=w> </span><span class=n>txInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createTransactionIfNecessary</span><span class=p>(</span><span class=n>tm</span><span class=p>,</span><span class=w> </span><span class=n>txAttr</span><span class=p>,</span><span class=w> </span><span class=n>joinpointIdentification</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>retVal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 这是一个环绕通知：调用拦截链中的下一个拦截器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 这通常会导致调用目标对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>retVal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>proceedWithInvocation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 目标调用异常处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>completeTransactionAfterThrowing</span><span class=p>(</span><span class=n>txInfo</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//清除事务信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>cleanupTransactionInfo</span><span class=p>(</span><span class=n>txInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//提交事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>commitTransactionAfterReturning</span><span class=p>(</span><span class=n>txInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>retVal</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//编程式事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 定义一个用于保存异常的持有者（ThrowableHolder）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ThrowableHolder</span><span class=w> </span><span class=n>throwableHolder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThrowableHolder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这是一个回调优先的事务管理器：传递一个 TransactionCallback 进去</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>CallbackPreferringPlatformTransactionManager</span><span class=p>)</span><span class=w> </span><span class=n>tm</span><span class=p>).</span><span class=na>execute</span><span class=p>(</span><span class=n>txAttr</span><span class=p>,</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>TransactionInfo</span><span class=w> </span><span class=n>txInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prepareTransactionInfo</span><span class=p>(</span><span class=n>tm</span><span class=p>,</span><span class=w> </span><span class=n>txAttr</span><span class=p>,</span><span class=w> </span><span class=n>joinpointIdentification</span><span class=p>,</span><span class=w> </span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>proceedWithInvocation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txAttr</span><span class=p>.</span><span class=na>rollbackOn</span><span class=p>(</span><span class=n>ex</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// 如果是一个需要回滚的运行时异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ex</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>)</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThrowableHolderException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// 正常返回值，将导致提交</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>throwableHolder</span><span class=p>.</span><span class=na>throwable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>cleanupTransactionInfo</span><span class=p>(</span><span class=n>txInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 检查结果状态：它可能指示一个需要重新抛出的 Throwable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>throwableHolder</span><span class=p>.</span><span class=na>throwable</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>throwableHolder</span><span class=p>.</span><span class=na>throwable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ThrowableHolderException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>getCause</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>TransactionSystemException</span><span class=w> </span><span class=n>ex2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>throwableHolder</span><span class=p>.</span><span class=na>throwable</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Application exception overridden by commit exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>throwableHolder</span><span class=p>.</span><span class=na>throwable</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ex2</span><span class=p>.</span><span class=na>initApplicationException</span><span class=p>(</span><span class=n>throwableHolder</span><span class=p>.</span><span class=na>throwable</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>ex2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>ex2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>throwableHolder</span><span class=p>.</span><span class=na>throwable</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Application exception overridden by commit exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>throwableHolder</span><span class=p>.</span><span class=na>throwable</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>ex2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>createTransactionIfNecessary</strong></p><blockquote><p>作用是在需要时创建事务。主要任务是准备并启动一个新的事务，或者参与一个现有的事务。
1、是否确定需要事务
根据传入的事务属性TransactionAttribute，判断是否需要创建一个新的事务，如果属性表明不需要事务，该方法会直接返回。</p><p>2、创建事务状态(TransactionStatus)
如果需要创建事务，它会调用事务管理器getTransaction方法来获取事务状态对象(TransactionStatus)。
这个类主要提供对事务状态的控制和查询，使得开发人员能够在编译过程中准确地管理事务的生命周期，包括事务的开始、提交、回滚以及其他状态检查。
主要职责和作用：
1）、判断事务是否处于新创建状态
用于告诉我们当前事务是否时新创建的，还是一个现有事务的一部分。这对于处理事务传播行为尤其重要。
2）、标记事务的完成状态
提供了方法来标记事务是否已经完成，以避免重复提交或回滚
3）、回滚状态管理
它可以标记事务为回滚状态，让事务管理器知道在提交的时候回滚事务，而不是提交。
4）、事务嵌套和保存点管理
会包含相关的方法和状态，用于处理事务的嵌套层次和保存点操作。
5）、只读事务标记
它可以指示当前事务是否是只读。这对优化数据库资源管理有帮助。</p><p>3、保存事务信息
将事务信息保存到TransactionInfo对象中。
这包括事务管理器、事务属性、事务状态以及其他相关信息。TransactionInfo用于在后续处理过程中跟踪和管理事务。</p><p>4、绑定事务到当前线程
通常会将TransactionInfo绑定到当前线程的上下文，使得后续方法调用中可以方便的访问和操作事务信息。这对支持事务传播行为（嵌套事务或事务参与）非常重要。</p><p>5、返回事务信息
最终返回TransactionInfo对象，以便调用方能够继续处理事务逻辑。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=n>TransactionInfo</span><span class=w> </span><span class=nf>createTransactionIfNecessary</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>PlatformTransactionManager</span><span class=w> </span><span class=n>tm</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>TransactionAttribute</span><span class=w> </span><span class=n>txAttr</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>joinpointIdentification</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 如果事务属性存在且没有指定事务名称，则使用方法标识作为事务名称。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txAttr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>txAttr</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// 创建一个新的 DelegatingTransactionAttribute 实例，重写 getName 方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// 使其返回 joinpointIdentification 作为事务名称。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>txAttr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DelegatingTransactionAttribute</span><span class=p>(</span><span class=n>txAttr</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getName</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=n>joinpointIdentification</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>TransactionStatus</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// 初始化事务状态为 null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txAttr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 如果事务属性不为空</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 并且事务管理器不为空</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// 使用事务管理器根据事务属性获取事务状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tm</span><span class=p>.</span><span class=na>getTransaction</span><span class=p>(</span><span class=n>txAttr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 如果事务管理器为空</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// 如果日志记录级别为 debug，则记录一条调试信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=p>.</span><span class=na>isDebugEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Skipping transactional joinpoint [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>joinpointIdentification</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=s>&#34;] because no transaction manager has been configured&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 调用 prepareTransactionInfo 方法准备事务信息，并返回 TransactionInfo 对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>prepareTransactionInfo</span><span class=p>(</span><span class=n>tm</span><span class=p>,</span><span class=w> </span><span class=n>txAttr</span><span class=p>,</span><span class=w> </span><span class=n>joinpointIdentification</span><span class=p>,</span><span class=w> </span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>1、tm.getTransaction</strong></p><blockquote><p>通过事务源初始化事务状态。
主要流程：</p><ul><li>doGetTransaction<ul><li>通过这个方法获取当前线程关联的事务对象。</li></ul></li><li>缓存日志标志<ul><li>一次获取当参数传入避免重复检查</li></ul></li><li>处理空事务定义<ul><li>如果事务定义为空，则返回默认事务定义DefaultTransactionDefinition</li></ul></li><li>检查现有事务<ul><li>如果存在事务，调用handeExistingTransaction</li></ul></li><li>检查事务超时时间<ul><li>确保事务定义中的超时时间有效</li></ul></li><li>单独处理mandatory传播的事务<ul><li>如果存在事务则抛出异常</li></ul></li><li>处理需要创建新事务的传播机制<ul><li>Required、Required_New、Nested，开启新事务，并处理异常恢复</li></ul></li><li>处理其他情况<ul><li>对于事务支持与不支持的情况，处理自定义隔离级别的日志告警，并返回事务状态。</li></ul></li></ul></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>TransactionStatus</span><span class=w> </span><span class=nf>getTransaction</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=w> </span><span class=n>definition</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>TransactionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//获取事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>transaction</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>doGetTransaction</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Cache debug flag to avoid repeated checks.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//缓存日志记录器的调试标志，以避免重复检查</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>debugEnabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>logger</span><span class=p>.</span><span class=na>isDebugEnabled</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>definition</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Use defaults if no transaction definition given.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>definition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultTransactionDefinition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//判断当前是否存在事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isExistingTransaction</span><span class=p>(</span><span class=n>transaction</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Existing transaction found -&gt; check propagation behavior to find out how to behave.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//如果当前有事务，则处理该事务，返回TransactionStatus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>handleExistingTransaction</span><span class=p>(</span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=n>debugEnabled</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Check definition settings for new transaction.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//检查事务中定义的超时时间是否合法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>getTimeout</span><span class=p>()</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>TIMEOUT_DEFAULT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//超时时间只能小于默认值，大于则抛出异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InvalidTimeoutException</span><span class=p>(</span><span class=s>&#34;Invalid transaction timeout&#34;</span><span class=p>,</span><span class=w> </span><span class=n>definition</span><span class=p>.</span><span class=na>getTimeout</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// No existing transaction found -&gt; check propagation behavior to find out how to proceed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//处理事务传播行为Propagation_Mandatory  不存在事务则抛出异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>getPropagationBehavior</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>PROPAGATION_MANDATORY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalTransactionStateException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;No existing transaction found for transaction marked with propagation &#39;mandatory&#39;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//处理需要新建事务的情况，Required、Required_new、Nested</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>getPropagationBehavior</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>PROPAGATION_REQUIRED</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>definition</span><span class=p>.</span><span class=na>getPropagationBehavior</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>PROPAGATION_REQUIRES_NEW</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>definition</span><span class=p>.</span><span class=na>getPropagationBehavior</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>PROPAGATION_NESTED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//挂起当前事务，并保存事务资源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SuspendedResourcesHolder</span><span class=w> </span><span class=n>suspendedResources</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>suspend</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//根据日志级别决定是否输出调试信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>debugEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Creating new transaction with name [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>definition</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>definition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 判断是否需要新建事务同步</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>newSynchronization</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>getTransactionSynchronization</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>SYNCHRONIZATION_NEVER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//创建新的事务状态DefaultTransactionStatus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DefaultTransactionStatus</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTransactionStatus</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>newSynchronization</span><span class=p>,</span><span class=w> </span><span class=n>debugEnabled</span><span class=p>,</span><span class=w> </span><span class=n>suspendedResources</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//开启新事物</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doBegin</span><span class=p>(</span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=n>definition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//准备事务同步回调</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>prepareSynchronization</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>definition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>返回新的事务状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>resume</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>suspendedResources</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//处理其他事务传播行为情况，例如SUPPORTS、NOT_SUPPORTED、NEVER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Create &#34;empty&#34; transaction: no actual transaction, but potentially synchronization.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果指定了自定义的隔离级别，但是没有实际启动事务，记录告警日志</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>getIsolationLevel</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>ISOLATION_DEFAULT</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>logger</span><span class=p>.</span><span class=na>isWarnEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logger</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Custom isolation level specified but no actual transaction initiated; &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;isolation level will effectively be ignored: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>definition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//判断是否需要启动事务同步</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>newSynchronization</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>getTransactionSynchronization</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>SYNCHRONIZATION_ALWAYS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//返回一个准备好的事务，这时没有实际启动事务，但是可能会进行事务同步</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>prepareTransactionStatus</span><span class=p>(</span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>newSynchronization</span><span class=p>,</span><span class=w> </span><span class=n>debugEnabled</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>handleExistingTransaction</strong></p><blockquote><p>处理当前线程已经绑定事务的情况。
这个方法会根据事务的传播行为、隔离级别等事务定义参数来决定如何处理现有事务.
大致逻辑处理如下：</p><ul><li>Requeired<ul><li>如果当前已有事务存在，直接参与一个现有事务；</li></ul></li><li>Required_New<ul><li>挂起当前事务，创建一个新事务。</li></ul></li><li>Nested<ul><li>如果底层的事务管理器支持嵌套事务，则在现有事务中创建一个嵌套事务。</li></ul></li><li>Supprts、Not_Supported、Never等<ul><li>这些传播行为可能决定不创建新的事务，或根据传播行为决定参与不参与现有事务。</li></ul></li></ul></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=n>TransactionStatus</span><span class=w> </span><span class=nf>handleExistingTransaction</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>TransactionDefinition</span><span class=w> </span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>debugEnabled</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=kd>throws</span><span class=w> </span><span class=n>TransactionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//如果传播行为是Never 则抛出异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>getPropagationBehavior</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>PROPAGATION_NEVER</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalTransactionStateException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;Existing transaction found for transaction marked with propagation &#39;never&#39;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>getPropagationBehavior</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>PROPAGATION_NOT_SUPPORTED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>debugEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Suspending current transaction&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//如果当前传播行为是not support 则挂起事务以无事务方式执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>suspendedResources</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>suspend</span><span class=p>(</span><span class=n>transaction</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>newSynchronization</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>getTransactionSynchronization</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>SYNCHRONIZATION_ALWAYS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//没有事务直接返回无事务状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>prepareTransactionStatus</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>newSynchronization</span><span class=p>,</span><span class=w> </span><span class=n>debugEnabled</span><span class=p>,</span><span class=w> </span><span class=n>suspendedResources</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>getPropagationBehavior</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>PROPAGATION_REQUIRES_NEW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//如果事务的传播行为是Requried_new 则挂起当前事务，创建一个新事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>debugEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Suspending current transaction, creating new transaction with name [&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>definition</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SuspendedResourcesHolder</span><span class=w> </span><span class=n>suspendedResources</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>suspend</span><span class=p>(</span><span class=n>transaction</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>newSynchronization</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>getTransactionSynchronization</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>SYNCHRONIZATION_NEVER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DefaultTransactionStatus</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTransactionStatus</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>newSynchronization</span><span class=p>,</span><span class=w> </span><span class=n>debugEnabled</span><span class=p>,</span><span class=w> </span><span class=n>suspendedResources</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doBegin</span><span class=p>(</span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=n>definition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>prepareSynchronization</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>definition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=n>beginEx</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>resumeAfterBeginException</span><span class=p>(</span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=n>suspendedResources</span><span class=p>,</span><span class=w> </span><span class=n>beginEx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>beginEx</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>getPropagationBehavior</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>PROPAGATION_NESTED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//如果事务的传播行为是nested，则启动一个嵌套事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isNestedTransactionAllowed</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NestedTransactionNotSupportedException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;Transaction manager does not allow nested transactions by default - &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;specify &#39;nestedTransactionAllowed&#39; property with value &#39;true&#39;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>debugEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Creating nested transaction with name [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>definition</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>useSavepointForNestedTransaction</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Create savepoint within existing Spring-managed transaction,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// through the SavepointManager API implemented by TransactionStatus.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DefaultTransactionStatus</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>prepareTransactionStatus</span><span class=p>(</span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>debugEnabled</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>status</span><span class=p>.</span><span class=na>createAndHoldSavepoint</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Nested transaction through nested begin and commit/rollback calls.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Usually only for JTA: Spring synchronization might get activated here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// in case of a pre-existing JTA transaction.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//其他传播方式默认参与现有事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>newSynchronization</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>getTransactionSynchronization</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>SYNCHRONIZATION_NEVER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DefaultTransactionStatus</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTransactionStatus</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>newSynchronization</span><span class=p>,</span><span class=w> </span><span class=n>debugEnabled</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doBegin</span><span class=p>(</span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=n>definition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>prepareSynchronization</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>definition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Assumably PROPAGATION_SUPPORTS or PROPAGATION_REQUIRED.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>debugEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Participating in existing transaction&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isValidateExistingTransaction</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>getIsolationLevel</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>ISOLATION_DEFAULT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Integer</span><span class=w> </span><span class=n>currentIsolationLevel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TransactionSynchronizationManager</span><span class=p>.</span><span class=na>getCurrentTransactionIsolationLevel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>currentIsolationLevel</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>currentIsolationLevel</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>definition</span><span class=p>.</span><span class=na>getIsolationLevel</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Constants</span><span class=w> </span><span class=n>isoConstants</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DefaultTransactionDefinition</span><span class=p>.</span><span class=na>constants</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalTransactionStateException</span><span class=p>(</span><span class=s>&#34;Participating transaction with definition [&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>definition</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;] specifies isolation level which is incompatible with existing transaction: &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>(</span><span class=n>currentIsolationLevel</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>isoConstants</span><span class=p>.</span><span class=na>toCode</span><span class=p>(</span><span class=n>currentIsolationLevel</span><span class=p>,</span><span class=w> </span><span class=n>DefaultTransactionDefinition</span><span class=p>.</span><span class=na>PREFIX_ISOLATION</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=s>&#34;(unknown)&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>definition</span><span class=p>.</span><span class=na>isReadOnly</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>TransactionSynchronizationManager</span><span class=p>.</span><span class=na>isCurrentTransactionReadOnly</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalTransactionStateException</span><span class=p>(</span><span class=s>&#34;Participating transaction with definition [&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>definition</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;] is not marked as read-only but existing transaction is&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>newSynchronization</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>getTransactionSynchronization</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>SYNCHRONIZATION_NEVER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>prepareTransactionStatus</span><span class=p>(</span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>newSynchronization</span><span class=p>,</span><span class=w> </span><span class=n>debugEnabled</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>prepareSynchronization</strong></p><blockquote><p>在事务管理中扮演重要角色，主要负责为事务同步过程做准备。
事务同步是指在事务的生命周期内，与当前事务关联的资源和回调函数进行协调，以确保事务的一致性和正确性。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>DefaultTransactionStatus</span><span class=w> </span><span class=nf>prepareTransactionStatus</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TransactionDefinition</span><span class=w> </span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>newTransaction</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>newSynchronization</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>debug</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>suspendedResources</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DefaultTransactionStatus</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTransactionStatus</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=n>newTransaction</span><span class=p>,</span><span class=w> </span><span class=n>newSynchronization</span><span class=p>,</span><span class=w> </span><span class=n>debug</span><span class=p>,</span><span class=w> </span><span class=n>suspendedResources</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>prepareSynchronization</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>definition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>prepareSynchronization</span><span class=p>(</span><span class=n>DefaultTransactionStatus</span><span class=w> </span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=w> </span><span class=n>definition</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>//检查事务状态是否是新的同步状态	</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isNewSynchronization</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//设置当前线程的事务活动状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>TransactionSynchronizationManager</span><span class=p>.</span><span class=na>setActualTransactionActive</span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>hasTransaction</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//根据传入的事务定义设置当前事务的隔离级别</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>TransactionSynchronizationManager</span><span class=p>.</span><span class=na>setCurrentTransactionIsolationLevel</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>definition</span><span class=p>.</span><span class=na>getIsolationLevel</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>ISOLATION_DEFAULT</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>							</span><span class=n>definition</span><span class=p>.</span><span class=na>getIsolationLevel</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//设置当前事务是否为只读</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>TransactionSynchronizationManager</span><span class=p>.</span><span class=na>setCurrentTransactionReadOnly</span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>isReadOnly</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//设置当前事务的名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>TransactionSynchronizationManager</span><span class=p>.</span><span class=na>setCurrentTransactionName</span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//这里通常注册需要在事务提交或回滚时调用的回调函数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>TransactionSynchronizationManager</span><span class=p>.</span><span class=na>initSynchronization</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>doBegin</strong></p><blockquote><p>确保了一个新的JDBC事务能够被正确初始化，并与当前线程绑定以支持事务管理。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doBegin</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>transaction</span><span class=p>,</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=w> </span><span class=n>definition</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//将传入的事务对象转换为DataSource TransactionObject类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>DataSourceTransactionObject</span><span class=w> </span><span class=n>txObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DataSourceTransactionObject</span><span class=p>)</span><span class=w> </span><span class=n>transaction</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>Connection</span><span class=w> </span><span class=n>con</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//检查事务对象是否有连接持有者，或者连接持有者是否已与事务同步</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>txObject</span><span class=p>.</span><span class=na>hasConnectionHolder</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>txObject</span><span class=p>.</span><span class=na>getConnectionHolder</span><span class=p>().</span><span class=na>isSynchronizedWithTransaction</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//获取新的数据库连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>Connection</span><span class=w> </span><span class=n>newCon</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>obtainDataSource</span><span class=p>().</span><span class=na>getConnection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=p>.</span><span class=na>isDebugEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Acquired Connection [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>newCon</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;] for JDBC transaction&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//将新的连接包装到ConnnectHolder中，并设置为事务对象的连接持有者</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>txObject</span><span class=p>.</span><span class=na>setConnectionHolder</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ConnectionHolder</span><span class=p>(</span><span class=n>newCon</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//将连接持有者标记为事务同步</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>txObject</span><span class=p>.</span><span class=na>getConnectionHolder</span><span class=p>().</span><span class=na>setSynchronizedWithTransaction</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//获取实际的数据库连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>con</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>txObject</span><span class=p>.</span><span class=na>getConnectionHolder</span><span class=p>().</span><span class=na>getConnection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//准备连接的事务隔离级别，并保存之前的隔离级别</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>Integer</span><span class=w> </span><span class=n>previousIsolationLevel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DataSourceUtils</span><span class=p>.</span><span class=na>prepareConnectionForTransaction</span><span class=p>(</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>definition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>txObject</span><span class=p>.</span><span class=na>setPreviousIsolationLevel</span><span class=p>(</span><span class=n>previousIsolationLevel</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// Switch to manual commit if necessary. This is very expensive in some JDBC drivers,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// so we don&#39;t want to do it unnecessarily (for example if we&#39;ve explicitly</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// configured the connection pool to set it already).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//如果连接是自动提交模式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>con</span><span class=p>.</span><span class=na>getAutoCommit</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>txObject</span><span class=p>.</span><span class=na>setMustRestoreAutoCommit</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=p>.</span><span class=na>isDebugEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Switching JDBC Connection [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>con</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;] to manual commit&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>con</span><span class=p>.</span><span class=na>setAutoCommit</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//准备事务性连接，以便满足事务定义的要求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>prepareTransactionalConnection</span><span class=p>(</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>definition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 将连接持有者标记为活动事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>txObject</span><span class=p>.</span><span class=na>getConnectionHolder</span><span class=p>().</span><span class=na>setTransactionActive</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//确定事务的超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=kt>int</span><span class=w> </span><span class=n>timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>determineTimeout</span><span class=p>(</span><span class=n>definition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>timeout</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TransactionDefinition</span><span class=p>.</span><span class=na>TIMEOUT_DEFAULT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>txObject</span><span class=p>.</span><span class=na>getConnectionHolder</span><span class=p>().</span><span class=na>setTimeoutInSeconds</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// Bind the connection holder to the thread.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//如果这是一个新的连接持有者，则将其绑定到当前线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txObject</span><span class=p>.</span><span class=na>isNewConnectionHolder</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>TransactionSynchronizationManager</span><span class=p>.</span><span class=na>bindResource</span><span class=p>(</span><span class=n>obtainDataSource</span><span class=p>(),</span><span class=w> </span><span class=n>txObject</span><span class=p>.</span><span class=na>getConnectionHolder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//发生异常，并且这是一个新的连接持有者，则释放并清空连接持有者。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txObject</span><span class=p>.</span><span class=na>isNewConnectionHolder</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>DataSourceUtils</span><span class=p>.</span><span class=na>releaseConnection</span><span class=p>(</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>obtainDataSource</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>txObject</span><span class=p>.</span><span class=na>setConnectionHolder</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//抛出无法创建事务的异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CannotCreateTransactionException</span><span class=p>(</span><span class=s>&#34;Could not open JDBC Connection for transaction&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>2、prepareTransactionInfo</strong></p><blockquote><p>构建事务信息
这段代码主要作用是返回一个TransactionInfo对象，包含与当前事务相关的信息。如果需要事务支持，则设置新的事务状态，并将TransactionInfo绑定到当前线程，即使不需要事务也会进行正常绑定，确保事务的正确管理。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=n>TransactionInfo</span><span class=w> </span><span class=nf>prepareTransactionInfo</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>PlatformTransactionManager</span><span class=w> </span><span class=n>tm</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>TransactionAttribute</span><span class=w> </span><span class=n>txAttr</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>joinpointIdentification</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>TransactionStatus</span><span class=w> </span><span class=n>status</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//创建一个新的Transaction 对象，该对象将保存有关的事务信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>TransactionInfo</span><span class=w> </span><span class=n>txInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransactionInfo</span><span class=p>(</span><span class=n>tm</span><span class=p>,</span><span class=w> </span><span class=n>txAttr</span><span class=p>,</span><span class=w> </span><span class=n>joinpointIdentification</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//如果事务属性不为空，则表示该方法需要事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txAttr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// We need a transaction for this method...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//如果日志级别为TRACE，记录一条跟踪消息，表明正在获取事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=p>.</span><span class=na>isTraceEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>logger</span><span class=p>.</span><span class=na>trace</span><span class=p>(</span><span class=s>&#34;Getting transaction for [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>txInfo</span><span class=p>.</span><span class=na>getJoinpointIdentification</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// The transaction manager will flag an error if an incompatible tx already exists.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>//设置新的事务状态，如果已经存在不兼容的事务，事务管理器会标记错误</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>txInfo</span><span class=p>.</span><span class=na>newTransactionStatus</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// The TransactionInfo.hasTransaction() method will return false. We created it only</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// to preserve the integrity of the ThreadLocal stack maintained in this class.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>//如果事务属性为空，表示该方法不需要事务。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//这里记录一条跟踪消息，表明不需要为该方法创建事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=p>.</span><span class=na>isTraceEnabled</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>logger</span><span class=p>.</span><span class=na>trace</span><span class=p>(</span><span class=s>&#34;Don&#39;t need to create transaction for [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>joinpointIdentification</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=s>&#34;]: This method isn&#39;t transactional.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// We always bind the TransactionInfo to the thread, even if we didn&#39;t create</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// a new transaction here. This guarantees that the TransactionInfo stack</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// will be managed correctly even if no transaction was created by this aspect.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//不管需不需要创建事务，我们也总是将TransactionInfo绑定到线程到当前线程。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>txInfo</span><span class=p>.</span><span class=na>bindToThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=n>txInfo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>completeTransactionAfterThrowing</strong></p><blockquote><p>主要作用是在发生异常的情况下，能够正确的处理事务，包括回滚事务和清理相关资源，以保持数据的完整性和一致性。
主要作用：</p><ul><li>捕获异常<ul><li>当事务中的某个操作抛出异常时，事务管理器会捕获到这个异常</li></ul></li><li>标记回滚<ul><li>completeTransactionAfterThrowing方法会根据捕获到的异常类型决定是否需要回滚事务。一般情况下，事务管理器会选择回滚事务，以保证数据的一致性。</li></ul></li><li>执行回滚<ul><li>如果需要回滚，事务管理器就会调用回滚操作，将所有已经进行的数据库操作撤销，恢复到事务开始前的状态。</li></ul></li><li>清理资源<ul><li>在回滚之后，方法还负责清理事务相关的资源，比如关闭数据库连接，释放锁等。</li></ul></li><li>重新抛出异常<ul><li>最后，该方法会重新抛出原始异常，以便让上层调用者知道事务过程出现了问题，并采取适当的措施（如记录日志、通知用户等）。</li></ul></li></ul></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>completeTransactionAfterThrowing</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>TransactionInfo</span><span class=w> </span><span class=n>txInfo</span><span class=p>,</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//检查transactionInfo和transactionStatus是否为空</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>txInfo</span><span class=p>.</span><span class=na>getTransactionStatus</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//根据日志级别决定是否打印追踪日志</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=p>.</span><span class=na>isTraceEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>logger</span><span class=p>.</span><span class=na>trace</span><span class=p>(</span><span class=s>&#34;Completing transaction for [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>txInfo</span><span class=p>.</span><span class=na>getJoinpointIdentification</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=s>&#34;] after exception: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//检查事务属性是否存在，以及检查异常是否触发回滚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txInfo</span><span class=p>.</span><span class=na>transactionAttribute</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>txInfo</span><span class=p>.</span><span class=na>transactionAttribute</span><span class=p>.</span><span class=na>rollbackOn</span><span class=p>(</span><span class=n>ex</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//执行回滚操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>txInfo</span><span class=p>.</span><span class=na>getTransactionManager</span><span class=p>().</span><span class=na>rollback</span><span class=p>(</span><span class=n>txInfo</span><span class=p>.</span><span class=na>getTransactionStatus</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>TransactionSystemException</span><span class=w> </span><span class=n>ex2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//处理回滚中抛出的异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Application exception overridden by rollback exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>ex2</span><span class=p>.</span><span class=na>initApplicationException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span><span class=c1>//初始化应用程序异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>throw</span><span class=w> </span><span class=n>ex2</span><span class=p>;</span><span class=c1>//再次抛出异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=n>ex2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//处理回滚过程中抛出的其他异常 RuntimeException 或Error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Application exception overridden by rollback exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>throw</span><span class=w> </span><span class=n>ex2</span><span class=p>;</span><span class=c1>//抛出新的异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// We don&#39;t roll back on this exception.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// Will still roll back if TransactionStatus.isRollbackOnly() is true.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>//如果不需要回滚，尝试提交事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//但是如果TransactionStatus被标记了只回滚，则依然会回滚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>txInfo</span><span class=p>.</span><span class=na>getTransactionManager</span><span class=p>().</span><span class=na>commit</span><span class=p>(</span><span class=n>txInfo</span><span class=p>.</span><span class=na>getTransactionStatus</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>TransactionSystemException</span><span class=w> </span><span class=n>ex2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//处理提交过程中抛出的异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Application exception overridden by commit exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>ex2</span><span class=p>.</span><span class=na>initApplicationException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>throw</span><span class=w> </span><span class=n>ex2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=n>ex2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 处理提交过程中抛出的其他 RuntimeException 或 Error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Application exception overridden by commit exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>throw</span><span class=w> </span><span class=n>ex2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>rollback</strong></p><blockquote><p>事务回滚。
它确保了在事务回滚时正确的触发前、后处理的方法，并根据事务的具体状态执行适当的回滚操作。
具体逻辑如下：</p><ul><li>触发方法调用<ul><li>triggerBeforeCompletion()和triggerAfterCompletion()分别在事务提交前和事务完成后触发。</li></ul></li><li>不同的回滚操作<ul><li>根据事务的状态选择回滚到保存点、完全回滚或者让事务发起方决定回滚。</li></ul></li><li>异常处理<ul><li>捕获并重新抛出运行时异常或错误，确保事务状态得到正确的处理。</li></ul></li><li>意外回滚处理<ul><li>如果事务被标记为仅回滚，根据配置决定是否抛出UnexceptionRollbackException异常。</li></ul></li><li>最终清理<ul><li>无论如何都会执行cleanAfterComplete来清理事务状态。</li></ul></li></ul></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>rollback</span><span class=p>(</span><span class=n>TransactionStatus</span><span class=w> </span><span class=n>status</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>TransactionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//如果事务提交了就不能回滚了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isCompleted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalTransactionStateException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=s>&#34;Transaction is already completed - do not call commit or rollback more than once per transaction&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>DefaultTransactionStatus</span><span class=w> </span><span class=n>defStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DefaultTransactionStatus</span><span class=p>)</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//执行回滚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>processRollback</span><span class=p>(</span><span class=n>defStatus</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processRollback</span><span class=p>(</span><span class=n>DefaultTransactionStatus</span><span class=w> </span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>unexpected</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//标记是否发生意外回滚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=kt>boolean</span><span class=w> </span><span class=n>unexpectedRollback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unexpected</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//触发事务提交前的操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>triggerBeforeCompletion</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//根据事务状态执行回滚操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>hasSavepoint</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//如果存在保存点，则回滚到保存点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isDebug</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Rolling back transaction to savepoint&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>status</span><span class=p>.</span><span class=na>rollbackToHeldSavepoint</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isNewTransaction</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//如果是新事务，则执行完全回滚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isDebug</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Initiating transaction rollback&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>doRollback</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=c1>// Participating in larger transaction</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//参与更大事务中的事务回滚处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>hasTransaction</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//如果事务标记为本地回滚或参与失败全局回滚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isLocalRollbackOnly</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>isGlobalRollbackOnParticipationFailure</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>							</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isDebug</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>								</span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Participating transaction failed - marking existing transaction as rollback-only&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>							</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>							</span><span class=n>doSetRollbackOnly</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=c1>//将事务标记为仅回滚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>							</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isDebug</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>								</span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Participating transaction failed - letting transaction originator decide on rollback&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>							</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Should roll back transaction but cannot - no transaction available&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=c1>// Unexpected rollback only matters here if we&#39;re asked to fail early</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//如果不需要在全局回滚时立即失败，则取消意外回滚标记</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isFailEarlyOnGlobalRollbackOnly</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=n>unexpectedRollback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//捕获并处理任何运行时异常或错误</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>triggerAfterCompletion</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>TransactionSynchronization</span><span class=p>.</span><span class=na>STATUS_UNKNOWN</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//触发事务完成之后的操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>triggerAfterCompletion</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>TransactionSynchronization</span><span class=p>.</span><span class=na>STATUS_ROLLED_BACK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// Raise UnexpectedRollbackException if we had a global rollback-only marker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//如果标记为意外回滚，则抛出异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unexpectedRollback</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnexpectedRollbackException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=s>&#34;Transaction rolled back because it has been marked as rollback-only&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//清理事务完成后的状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>cleanupAfterCompletion</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>doRollBack</strong></p><blockquote><p>用于执行JDBC 事务的回滚操作。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doRollback</span><span class=p>(</span><span class=n>DefaultTransactionStatus</span><span class=w> </span><span class=n>status</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//获取事务对象，这里转化成基于数据源的事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>DataSourceTransactionObject</span><span class=w> </span><span class=n>txObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DataSourceTransactionObject</span><span class=p>)</span><span class=w> </span><span class=n>status</span><span class=p>.</span><span class=na>getTransaction</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//获取当前事务使用的连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Connection</span><span class=w> </span><span class=n>con</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>txObject</span><span class=p>.</span><span class=na>getConnectionHolder</span><span class=p>().</span><span class=na>getConnection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//根据模式选择是否记录日志</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isDebug</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Rolling back JDBC transaction on Connection [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>con</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//执行JDBC连接的回滚操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>con</span><span class=p>.</span><span class=na>rollback</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>SQLException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransactionSystemException</span><span class=p>(</span><span class=s>&#34;Could not roll back JDBC transaction&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>commitAfterReturning</strong></p><blockquote><p>常用于在目标方法成功执行完成后的提交事务。这个方法能够确保在业务逻辑正确完成后数据库变更被持久化。
具体执行逻辑如下：</p><ul><li>获取事务状态<ul><li>获取当前事务状态，准备提交操作。</li></ul></li><li>提交事务<ul><li>提交事务，将所有变更持久化到数据库。</li></ul></li><li>日志记录<ul><li>如果调试模式开启，记录提交事务的日志信息。</li></ul></li><li>异常处理<ul><li>捕获并处理DataAccessException异常，如果提交的过程中发生任何问题，记录错误日志，并重新抛出异常。</li></ul></li></ul></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>commitTransactionAfterReturning</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>TransactionInfo</span><span class=w> </span><span class=n>txInfo</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>txInfo</span><span class=p>.</span><span class=na>getTransactionStatus</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=p>.</span><span class=na>isTraceEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logger</span><span class=p>.</span><span class=na>trace</span><span class=p>(</span><span class=s>&#34;Completing transaction for [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>txInfo</span><span class=p>.</span><span class=na>getJoinpointIdentification</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>txInfo</span><span class=p>.</span><span class=na>getTransactionManager</span><span class=p>().</span><span class=na>commit</span><span class=p>(</span><span class=n>txInfo</span><span class=p>.</span><span class=na>getTransactionStatus</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>commit</span><span class=p>(</span><span class=n>TransactionStatus</span><span class=w> </span><span class=n>status</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>TransactionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//事务已经提交不能再次提交</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isCompleted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalTransactionStateException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;Transaction is already completed - do not call commit or rollback more than once per transaction&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DefaultTransactionStatus</span><span class=w> </span><span class=n>defStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DefaultTransactionStatus</span><span class=p>)</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//如果事务设置了回滚标记则直接回滚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>defStatus</span><span class=p>.</span><span class=na>isLocalRollbackOnly</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>defStatus</span><span class=p>.</span><span class=na>isDebug</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Transactional code has requested rollback&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>processRollback</span><span class=p>(</span><span class=n>defStatus</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>shouldCommitOnGlobalRollbackOnly</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>defStatus</span><span class=p>.</span><span class=na>isGlobalRollbackOnly</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>defStatus</span><span class=p>.</span><span class=na>isDebug</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Global transaction is marked as rollback-only but transactional code requested commit&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>processRollback</span><span class=p>(</span><span class=n>defStatus</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//提交事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>processCommit</span><span class=p>(</span><span class=n>defStatus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processCommit</span><span class=p>(</span><span class=n>DefaultTransactionStatus</span><span class=w> </span><span class=n>status</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>TransactionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>beforeCompletionInvoked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>unexpectedRollback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//准备 提交前的处理阶段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>prepareForCommit</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//触发事务提交前的回调方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>triggerBeforeCommit</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//触发事务即将完成的回调方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>triggerBeforeCompletion</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>beforeCompletionInvoked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//根据事务不同的状态进行不同的提交处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>hasSavepoint</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//存在保存点，释放保存点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isDebug</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Releasing transaction savepoint&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unexpectedRollback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>status</span><span class=p>.</span><span class=na>isGlobalRollbackOnly</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>status</span><span class=p>.</span><span class=na>releaseHeldSavepoint</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isNewTransaction</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//新事务，记录是否回滚，直接提交</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isDebug</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Initiating transaction commit&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unexpectedRollback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>status</span><span class=p>.</span><span class=na>isGlobalRollbackOnly</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>doCommit</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isFailEarlyOnGlobalRollbackOnly</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 全局标记为回滚，根据配置执行相应处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unexpectedRollback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>status</span><span class=p>.</span><span class=na>isGlobalRollbackOnly</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Throw UnexpectedRollbackException if we have a global rollback-only</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// marker but still didn&#39;t get a corresponding exception from commit.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unexpectedRollback</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnexpectedRollbackException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;Transaction silently rolled back because it has been marked as rollback-only&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>UnexpectedRollbackException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// can only be caused by doCommit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>triggerAfterCompletion</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>TransactionSynchronization</span><span class=p>.</span><span class=na>STATUS_ROLLED_BACK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>TransactionException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// can only be caused by doCommit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isRollbackOnCommitFailure</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>doRollbackOnCommitException</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>triggerAfterCompletion</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>TransactionSynchronization</span><span class=p>.</span><span class=na>STATUS_UNKNOWN</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>beforeCompletionInvoked</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>triggerBeforeCompletion</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doRollbackOnCommitException</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Trigger afterCommit callbacks, with an exception thrown there</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// propagated to callers but the transaction still considered as committed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//触发事务提交后的回调方法，在此方法中的异常会被传播给调用者，但事务仍被认为是以提交状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>triggerAfterCommit</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//最终完成事务后的回调，进行清理工作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>triggerAfterCompletion</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>TransactionSynchronization</span><span class=p>.</span><span class=na>STATUS_COMMITTED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//完成事务处理之后的清理工作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cleanupAfterCompletion</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>方法执行流程解析：</p><ul><li>prepareForCommit：<ul><li>进入事务提交前的处理，执行准备工作。包括资源准备和一些事务状态的检查工作。</li></ul></li><li>triggerBeforeCommit<ul><li>触发事务提交前注册的回调方法，这些方法允许应用程序在事务提交前执行必要的逻辑，如数据预处理，或准备工作。</li></ul></li><li>triggerBeforeCompletion<ul><li>在事务即将完成时触发注册的回调。这个阶段标志着事务要进入最后的提交阶段。</li></ul></li><li>根据事务状态进行不同的提交处理<ul><li>存在保存点status.hasPoint<ul><li>如果存在保存点，则释放保存点，并检查全局回滚标志，决定是否要回滚事务。</li><li><strong>保存点</strong><ul><li><strong>保存点通常用于在事务执行的过程中的某一时刻创建一个快照，以便后续操作中能回滚到这个快照状态。</strong></li><li><strong>存在保存点的事务允许部分提交，可以选择性的提交部分事务，而其他回滚。</strong></li></ul></li></ul></li><li>新事物status.isNewTrasaction<ul><li>如果当前事务是新事务，即不存在保存点，检查是否回滚，执行提交操作。</li><li><strong>不存在保存点</strong><ul><li><strong>不存在保存点，说明事务在执行的过程中没有创建快照，事务只能作为一个整体要么回滚要么提交。</strong></li></ul></li></ul></li><li>全局标记为回滚<ul><li>如果配置要求在全局回滚是立即失败，则根据配置决定后续处理。</li></ul></li></ul></li><li>异常处理<ul><li>UnexceptionRollbackException<ul><li>如果在提交的过程中遇到这个异常，表示事务在不应回滚的情况下发生了意外回滚，此时会触发事务完成后的回调，并抛出异常。</li></ul></li><li>TransactionExceptio<ul><li>处理这个异常的时候根据配置决定是否回滚，或触发事务完成后的回调。</li></ul></li><li>RuntimeException | Error<ul><li>如果在事务完成前发生 RuntimeException 或 Error 异常，会在必要时触发事务即将完成的回调方法，并进行事务的回滚处理。</li></ul></li></ul></li><li>事务提交后的回调<ul><li>triggerAfterCommit方法， 在事务提交成功后，触发注册的事务提交后的回调方法，这些回调方法允许应用程序执行与事务提交成功相关的逻辑。</li></ul></li><li>事务完成后的清理<ul><li>cleanupAfterCompletion方法， 执行事务完成后的清理工作。包括清理事务状态、释放资源或者其他事务执行相关的清理操作。</li></ul></li></ul></blockquote><blockquote><ul><li>triggerAfterCommit<ul><li>仅当事务成功提交(即没有发生回滚)才会调用次方法。</li><li>主要用途<ul><li>通知监听器：通知那些关注事务提交成功的监听器，这些监听器可能会进行后续的处理，比如发布事件、更新缓存等。</li><li>业务逻辑执行：执行一些需要事务提交成功之后才能进行的业务逻辑，例如发送确认邮件、记录日志等。</li></ul></li><li>场景<ul><li>电商系统中，订单事务提交成功后，使用triggerAfterCommit方法发送订单确定邮件给用户。</li><li>银行系统中，转账事务提交成功后，通知相关系统更新账户余额。</li></ul></li></ul></li><li>cleanupAfterCompletion<ul><li>事务完成之后的清理工作</li><li>主要用途：<ul><li>释放事务过程中占用的相关资源，如数据库连接、锁等。</li><li>状态重置：重置或清理事务相关的状态信息，以准备下一次事务操作。</li><li>清理线程绑定：解除线程上绑定的事务信息， 避免线程重用时出现问题。</li></ul></li><li>场景<ul><li>基于数据库应用中这个方法会确保关闭数据库连接，并释放相关资源。</li><li>在分布式系统中，当事务完成之后，会解除对分布式事务上下文的绑定，防止后续影响</li></ul></li></ul></li></ul></blockquote><h3 id=3总结>3、总结</h3><h5 id=接口总结>接口总结：</h5><ul><li>@EnableTransactionManagement<ul><li>启动注解驱动事务管理功能</li></ul></li><li>@Transactional<ul><li>通过这个注解定义在，某个类或者某个方法上，开启事务。</li></ul></li><li>@TransactionEventListener<ul><li>事务事件监听器</li></ul></li><li>TransactionDefinition<ul><li>接口，事务定义，允许开发者指定事务的行为。</li><li>包括隔离级别、传播行为、超时设置、只读等</li></ul></li><li>TransactionStatus<ul><li>接口，事务状态；用于查询和控制当前的事务状态，进行事务的提交、回滚等处理。</li></ul></li><li>PlatformTransactionManager<ul><li>接口，事务管理；</li><li>核心方法：<ul><li>getTransaction<ul><li>开始一个新的事务，获取当前线程绑定的事务，如果存在的话</li></ul></li><li>commit<ul><li>提交事务，如果被标记了只回滚，则抛出异常，导致事务回滚。</li></ul></li><li>rollback<ul><li>回滚事务。</li></ul></li></ul></li></ul></li><li>ProxyTransactionManagementConfiguration<ul><li>代理配置类。配置和启用Spring事务管理功能，使用代理来拦截方法调用并应用事务逻辑</li></ul></li><li>BeanFactoryTransactionAttributeSourceAdvisor<ul><li>PointCutAdvisor的实现，作用是根据事务属性为匹配的切点应用事务增强。</li><li>通过TransactionAttributeSource的来实现<strong>切点定义</strong>,以确定哪些方法需要应用事务。</li><li>通过TransactionInterceptor来<strong>增强定义</strong>逻辑，包括事务管理器、事务属性解析器等，从而实现在匹配的切点上应用事务管理逻辑。</li></ul></li><li>TransactionInterceptor<ul><li>MethodInterceptor的实现，拦截器，作用是给被拦截的方法添加事务管理功能。</li></ul></li><li>TransactionAttributeSource<ul><li>接口，通过getTransactionAttribute获取TransactionAttribute</li><li>TransactionAttribute继承自TransactionDefinition。</li></ul></li></ul><h5 id=流程总结>流程总结：</h5><p>1、通过EnableTransactionManagement注解驱动整个Spring事务模块。
2、通过Transactional注解，标记在某个类或者方法上，定义事务传播类型，开启注解
3、通过ProxyTransactionMannagementConfiguration代理配置类来定义一个BeanFactoryTransactionAttributeSourceAdvisor切面，是一个用于Spring配置的AOP切面。
4、通过AOP切入点和切面（PointcutAdvisor关联的Pointcut内部有一个TransactionAttributeSource对象），利用TransactionAttributeSource确定方法的事务属性，再通过TransactionAnnotationParser解析@Transactional 注解，最终将解析的事务属性封装成TransactionDenifition事务定义对象。
5、Spring AOP 拦截处理在TransactionInterceptor中，先借助PlantformTransactionMannager平台事务管理器创建一个TransactionStatus事务状态对象，并将数据库连接自动提交autoCommit设置为false，TransactionStatus里面包含一个Transaction事务对象，方法执行完所有数据库操作都在一个对象里面。
6、spring事务依赖线程局部变量和事务同步管理器，通过者两者共同确保了事务操作的正确性和一致性。通过ThreadLocal存储DataSource、Connection和SqlSession等事务相关的局部变量。
通常讲，单体项目的事务都在一个线程中完成。
事务同步管理器，负责协调并管理事务相关的资源，包括事务状态、连接、会话等。
多个资源同步：一个事务中可能设计多个数据源、多个数据库连接或多个数据库会话。TransactionSynchronizationMannager确保它们的状态能够正确地同步和管理。</p></div><div class=post-footer></div></article></main></body></html>