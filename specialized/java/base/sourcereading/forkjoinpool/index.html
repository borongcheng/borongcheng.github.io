<!doctype html><html lang=zh-CN><head><title>ForkJoinPool // 笔记网站</title>
<link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.121.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="borong.cheng"><meta name=description content><link rel=stylesheet href=/static/css/main.min.b84e0970f1042270e748e500e667d336cc11fd43e14b8fd28a91b688e487575c.css><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://borongcheng.github.io/static/%E9%A6%96%E9%A1%B5%E4%B8%AD%E9%97%B4%E7%9A%84%E5%9B%BE%E7%89%87"><meta name=twitter:title content="ForkJoinPool"><meta name=twitter:description content="一、定义 forkjoinpool是java 7 开始提供的用于并行执行的任务框架，广泛用于java 8 的parallelStream和Comple"><meta property="og:title" content="ForkJoinPool"><meta property="og:description" content="一、定义 forkjoinpool是java 7 开始提供的用于并行执行的任务框架，广泛用于java 8 的parallelStream和Comple"><meta property="og:type" content="article"><meta property="og:url" content="https://borongcheng.github.io/static/specialized/java/base/sourcereading/forkjoinpool/"><meta property="og:image" content="https://borongcheng.github.io/static/%E9%A6%96%E9%A1%B5%E4%B8%AD%E9%97%B4%E7%9A%84%E5%9B%BE%E7%89%87"><meta property="article:section" content="specialized"><meta property="article:published_time" content="2025-07-25T09:52:00+00:00"><meta property="article:modified_time" content="2025-10-04T19:07:36+08:00"><meta property="og:site_name" content="柏荣的博客"></head><body><header class=app-header><a href=https://borongcheng.github.io/static/><img class=app-header-avatar src=/static/picture/daji.jpg alt=borong.cheng></a>
<span class=app-header-title>笔记网站</span><nav class=app-header-menu><a class=app-header-menu-item href=/static/>Home</a>
-
<a class=app-header-menu-item href=/static/categories/>类别</a>
-
<a class=app-header-menu-item href=/static/tags/>Tags</a></nav><p>柏荣的博客</p></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>ForkJoinPool</h1><div class=post-meta><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jul 25, 2025</div><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>5 min read</div><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://borongcheng.github.io/static/tags/java/>JAVA</a>
<a class=tag href=https://borongcheng.github.io/static/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/>线程池</a>
<a class=tag href=https://borongcheng.github.io/static/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/>源码阅读</a></div></div></header><div class=post-container><div class=post-toc-container><div class=post-toc><div class=post-toc-title>目录</div><div class=post-toc-content><nav><ul><li><a href=#一分治法>一、分治法</a></li><li><a href=#二工作窃取>二、工作窃取</a></li><li><a href=#三使用>三、使用</a></li><li><a href=#四源码阅读>四、源码阅读</a><ul><li></li></ul></li></ul></nav></div></div></div><div class=post-content><h1 id=一定义>一、定义</h1><p>forkjoinpool是java 7 开始提供的用于并行执行的任务框架，广泛用于java 8 的parallelStream和CompletableFuture。</p><p>其主旨是将大任务拆分成若干个小任务，然后并行执行这些小任务，最后汇总这些任务执行的结果。这部分主要采用<strong>分治法</strong>实现。</p><p>此外ForkJoinPool还采用了<strong>窃取算法</strong>，避免工作线程由于拆分任务之后的join等待过程，处于空闲的线程从其他工作线程的任务队列里面窃取任务来执行。</p><h1 id=二实现>二、实现</h1><h2 id=一分治法>一、分治法</h2><p>分治法的基本思想就是将一个规模为N的问题拆解成K个规模较小的同类型问题，这些子问题相互独立且与原问题类型一致。</p><p>求出子问题的解之后，将这些解合并，就可以得到原有问题的解。</p><p>例如：通过二分法在某个有序数组中查询一个数是否存在；</p><p>就可以将数组拆分成多个子集，然后并行的在这些子集里面查询。</p><p><img src=https://cdn.nlark.com/yuque/0/2025/png/22648511/1758095307251-8a9c6e81-5b5c-4ffd-b7a9-fb6ed78490a6.png alt></p><h2 id=二工作窃取>二、工作窃取</h2><p>工作窃取的本质是让空闲线程去抢夺其他线程任务队列中未被处理的任务，提高CPU效率节省资源。</p><p>forkJoinPool任务处理流程：</p><ul><li>每个工作线程在自己的调度队列中维护可运行的任务。</li><li>队列被维护成双端队列（Deque）。</li><li>任务从队列尾端插入，当前线程消费任务按照LIFO（后入先出）从队列尾端获取任务。</li><li>当前线程任调度队列任务为空时，会去其他线程的队列头获取任务FIFO（先入先出）。</li></ul><blockquote><p>线程正常消费和窃取任务分别在任务队列的两端，不会产生竞争。</p></blockquote><h2 id=三使用>三、使用</h2><p>实现ForkJoin框架主要有两个类，一个是ForkJoinPool和ForkJoinTask。</p><p>通常都是直接继承ForkJoinTask的子类，重写里面的Compute方法。</p><ul><li>RecursiveAction：无返回值的任务类。</li><li>RecursiveTask：有返回值的任务类。</li></ul><p>实例：</p><p>并行累加数值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>java.lang.bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.RecursiveAction</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//无返回值的任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RecursiveActionTest</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>RecursiveAction</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>start</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>RecursiveActionTest</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>start</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>end</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>start</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>compute</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//如果计算值差小于10 直接计算</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>start</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>end</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>sum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//通过拆分任务计算</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>middle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>start</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>end</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>RecursiveActionTest</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RecursiveActionTest</span><span class=p>(</span><span class=n>middle</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>RecursiveActionTest</span><span class=w> </span><span class=n>test1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RecursiveActionTest</span><span class=p>(</span><span class=n>start</span><span class=p>,</span><span class=w> </span><span class=n>middle</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>invokeAll</span><span class=p>(</span><span class=n>test</span><span class=p>,</span><span class=n>test1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>java.lang.bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.RecursiveTask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//有返回值的任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RecursiveTaskTest</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>RecursiveTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>start</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>RecursiveTaskTest</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>start</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>end</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>start</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>compute</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>start</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>end</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//通过拆分任务计算</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>middle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>start</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>end</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>RecursiveTaskTest</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RecursiveTaskTest</span><span class=p>(</span><span class=n>middle</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>RecursiveTaskTest</span><span class=w> </span><span class=n>test1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RecursiveTaskTest</span><span class=p>(</span><span class=n>start</span><span class=p>,</span><span class=w> </span><span class=n>middle</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>invokeAll</span><span class=p>(</span><span class=n>test</span><span class=p>,</span><span class=n>test1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>test</span><span class=p>.</span><span class=na>join</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>test1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>java.lang</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.bean.RecursiveActionTest</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.bean.RecursiveTaskTest</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.ForkJoinPool</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.ForkJoinTask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ForkJoinPoolTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ForkJoinPool</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ForkJoinPool</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//无返回值累加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>RecursiveActionTest</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=n>1000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;无返回值累加耗费时间：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;ms&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ForkJoinTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>joinTask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>RecursiveTaskTest</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Integer</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>joinTask</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;并行累加数值:&#34;</span><span class=o>+</span><span class=w> </span><span class=n>sum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=四源码阅读>四、源码阅读</h2><h4 id=构造方法>构造方法</h4><p><strong>有参构造</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>ForkJoinPool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>parallelism</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ForkJoinWorkerThreadFactory</span><span class=w> </span><span class=n>factory</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>UncaughtExceptionHandler</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>boolean</span><span class=w> </span><span class=n>asyncMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>(</span><span class=n>checkParallelism</span><span class=p>(</span><span class=n>parallelism</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>checkFactory</span><span class=p>(</span><span class=n>factory</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>handler</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>asyncMode</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>FIFO_QUEUE</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>LIFO_QUEUE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=s>&#34;ForkJoinPool-&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>nextPoolId</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;-worker-&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>checkPermission</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>参数说明：</p><ul><li>parallelism：当前forkJoinPool支持的最大并行数，会校验MAX_CAP（机器支持的最大线程数）。</li><li>factory：线程工厂，用于创建线程。</li><li>handler：用于异常处理的拒绝策略。</li><li>asyncMode：异步模式，true将采用FIFO（先进先出）的模式，false则采用FIFO（后进先出）的模式。</li></ul><p><strong>无参构造：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>ForkJoinPool</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>(</span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>MAX_CAP</span><span class=p>,</span><span class=w> </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>availableProcessors</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>defaultForkJoinWorkerThreadFactory</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>无参构造：</p><p>1、通过获取MAX_CAP 和当前系统允许最大并行数的最小值来设置并行量。</p><p>2、设置默认的线程工厂。</p><p>3、拒绝策略为空。</p><p>4、asyncMode为false。</p><h4 id=forkjoinpool的基本组成>ForkJoinPool的基本组成</h4><p>forkJoinPool实际是由WorkQueue的数据结构组成，而WorkQueue有分两类队列，一个是由外部提交任务的队列SubmissionQueue，另一个是和Work线程绑定的本地任务队列（里面的任务主要是通过work线程调用fork方法生成），且在主体队列的偶数位。</p><p><img src=https://cdn.nlark.com/yuque/0/2025/png/22648511/1758100657021-d6bfb892-647c-4bc6-8b5e-cfe90b4801ae.png alt></p><p>图解流程：</p><p>1、任务提交会被加入到submissionQueue队列中；</p><p>2、当前线程会拿到submissionQueue队列中的任务，fork出多个子任务存入与当前线程绑定的workQueue队列中。</p><p>3、当前线程绑定的workQueue队列中无任务，且相邻的submissionQueue队列中也无任务，会去其他线程的WorkQueue中窃取任务。（一般是窃取最旧的任务）</p><h4 id=任务队列初始化流程>任务队列初始化流程</h4><p>最开始，workQueues是null状态。在第一次执行的时候，externalSubmit方法中会初始化这个数组。</p><p><img src=https://cdn.nlark.com/yuque/0/2025/png/22648511/1758101317487-12f2ee7a-1225-41cc-9e2b-760d79e6c084.png alt></p><p>在这之后，还是在externalSubmit方法的for循环中，完成对任务队列的创建，将任务队列创建在偶数索引处。之后将任务写入这个队列：</p><p><img src=https://cdn.nlark.com/yuque/0/2025/png/22648511/1758101325691-5b0df9d6-d789-4935-a31c-793df16fe6f1.png alt></p><p>此后，任务添加完成，但是没有工作队列进行工作。因此在这之后调用signalWork，通知工作队列开始干活。但是在这个方法执行的过程中，由于工作队列并不存在，没有worker，所以调用tryAddWorker开始创建worker。在createWorker会创建一个worker线程：</p><p><img src=https://cdn.nlark.com/yuque/0/2025/png/22648511/1758101333040-a6877e8f-4bac-4ecb-9c7e-b6567049e10d.png alt></p><p>但是workQueue还没创建。这是在newthread之后，通过registerWorker创建的，在registerWorker方法中，会在奇数位创建一个workQueue，并将此前创建的线程与之绑定。这样一个worker就成功创建了。</p><p><img src=https://cdn.nlark.com/yuque/0/2025/png/22648511/1758101338874-9db359fc-01cb-4ba6-8791-420583f6939b.png alt></p><p>这样就完成了worker创建的全过程。</p><h4 id=工作流程>工作流程</h4><p>当workQueue上的thread启动之后，这个线程就会调用runWorker方法。之后再runWorker方法中有一个死循环，不断的通过scan方法去扫描任务，实际上就是执行窃取过程。如下图所示，这样通过遍历外层workQueues的方式将会从任务队列中窃取任务进行执行。</p><p><img src=https://cdn.nlark.com/yuque/0/2025/png/22648511/1758101552655-726f9a6b-a8ad-48e6-a7ed-3a007f72f8b2.png alt></p><p>当执行之后，会通过fork产生新的任务，将这些任务任务添加到工作队列中去。其他线程继续scan，执行。这个过程不断循环，直到任务全部都执行完成，这样就完成了整个计算过程。</p></div></div><div class=post-footer></div></article></main><script>document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".post-toc");if(e){const t=e.querySelector(".post-toc-title");window.innerWidth<=768&&t.addEventListener("click",function(){e.classList.toggle("active")});const n=e.querySelectorAll("a");n.forEach(t=>{t.addEventListener("click",function(t){t.preventDefault();const s=this.getAttribute("href").substring(1),n=document.getElementById(s);n&&(window.scrollTo({top:n.offsetTop-20,behavior:"smooth"}),window.innerWidth<=768&&e.classList.remove("active"))})})}})</script><script src=/static/js/back-button.min.fc91a7f6baac199fdacc77cc4db320ef5d39d48fd68258cbef8d1ccf2e6b8ea0.js defer></script></body></html>